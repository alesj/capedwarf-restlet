#!/bin/bash
# This is a simple script and will be executed on your CI system if 
# available.  Otherwise it will execute while your application is stopped
# before the build step.  This script gets executed directly, so it
# could be python, php, ruby, etc.

runtime_dir=${OPENSHIFT_HOMEDIR}app-root/runtime/
cd_home=${runtime_dir}capedwarf/
cd_modules=${cd_home}capedwarf-modules/jboss-as7-modules/

if [ ! -d "${cd_home}" ]; then
	mkdir ${cd_home}
fi
debug_log=${cd_home}install.log
date > $debug_log

REPO_DIR_SHARED_DATA=${runtime_dir}repo/share/
if [ ! -d "${REPO_DIR_SHARED_DATA}" ]; then
	mkdir ${REPO_DIR_SHARED_DATA}
	touch ${REPO_DIR_SHARED_DATA}application-users.properties
	touch ${REPO_DIR_SHARED_DATA}application-roles.properties
	touch ${REPO_DIR_SHARED_DATA}mgmt-users.properties
fi

source ${runtime_dir}repo/.openshift/action_hooks/utils.sh
echo "Sourced utils.sh" >> $debug_log

source $OPENSHIFT_CARTRIDGE_SDK_BASH

JBOSS_PATH=${OPENSHIFT_HOMEDIR}jbossas/
export OPENSHIFT_JBOSSAS_MODULE_PATH=${OPENSHIFT_HOMEDIR}app-root/runtime/capedwarf/capedwarf-modules/jboss-as7-modules

#set Admin password if it is not set yet
welcome_page_index=${runtime_dir}repo/src/main/webapp/index.html 

if grep -q -e "^admin" ${OPENSHIFT_DATA_DIR}application-users.properties; then
	echo "Admin password already set." | tee -a $debug_log

	if [ -f $welcome_page_index ]; then
		echo "Updating welcome page ${welcome_page_index}" >> $debug_log
		sed -i -e s/"\"<!--replace-with-pass-->\""/"which was shown here on a first deploy"/g ${welcome_page_index}
	else
		echo "Welcome page ${welcome_page_index} not found." >> $debug_log
	fi

else
	echo "Setting admin password." | tee -a $debug_log
	
	password=$(random_pass_required_chars)
	password=${password}$(generate_password)
	
	JBOSS_HOME_OLD=${JBOSS_HOME}
	export JBOSS_HOME=${JBOSS_PATH}

	${JAVA_HOME}/jre/bin/java \
		-Djboss.server.config.user.dir=$REPO_DIR_SHARED_DATA \
		-jar ${JBOSS_HOME}jboss-modules.jar \
		-mp ${cd_modules} \
		org.jboss.as.domain-add-user \
		-a -s -u admin -p ${password} -ro admin >> $debug_log

	export JBOSS_HOME=${JBOSS_HOME_OLD}
	
	if [ -f $welcome_page_index ]; then
		#first character must be escaped because it is a special char
		echo "Updating welcome page ${welcome_page_index}" >> $debug_log
		sed -i -e s/"<!--replace-with-pass-->"/"\\"${password}/g ${welcome_page_index}
	fi
	
fi

echo "CapeDwarf pre_build script finished." >> $debug_log
